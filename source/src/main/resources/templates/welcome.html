<head>
    <title>Identification Process</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            margin: 0;
            padding: 0;
            /*display: flex;*/
            /*justify-content: center;*/
            /*align-items: center;*/
            height: 100vh;
        }
        .main {
            width: 80%;
            max-width: 900px;
            margin: 50px auto;
        }
        h1 {
            text-align: center;
        }
        /* General Box Styling */
        .id-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .id-box h2 {
            text-align: center;
            color: #333;
        }
        .id-box .box-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        /* Personal Info Box */
        #user-form-container {
            border: 2px solid #007BFF;
        }
        /* Live Camera Box */
        #live-camera-container {
            border: 2px solid #007BFF;
            text-align: center;
        }
        #camera-preview {
            width: 100%;
            max-width: 400px;
            height: 250px;
            background: #ddd;
            display: none;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        #start-camera {
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 23px !important;
        }
        #scan-photo {
            background-color: #ffc107;
            color: black;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: none;
            margin-top: 0 !important;
        }
        /* ID Card Upload Box */
        #id-upload-container {
            border: 2px solid #007BFF;
            text-align: center;
        }
        #id-upload-container label {
            font-weight: bold;
        }
        .id-icon {
            font-size: 100px;
            color: #dc3545;
            margin-bottom: 34px;
            margin-top: 15px;
        }
        #elements{
            display: grid;
            grid-template-columns: 33% 33% 33%;
            gap:10px;
        }
        .input{
            width: 100%;
            display: grid;
            grid-template-columns: 37% 60% 3%;
            text-align: right;
            margin-top: 3px;
            margin-bottom: 3px;
        }
        .input input{
            width: auto;
            margin-left: 3px;
        }
        button {
            width: 100%;
            max-width: 120px;
            padding: 10px;
            font-size: 13px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: inline-block;
            margin: 5px;
        }

        /* Default Blue Button */
        .btn-primary {
            background-color: #007BFF;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }

        /* Green Button (Save, Confirm, Continue) */
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }

        /* Red Button (Cancel, Delete, Stop) */
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }

        /* Yellow Button (Scan, Warning, Secondary Actions) */
        .btn-warning {
            background-color: #ffc107;
            color: black;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }

        /* Gray Button (Disabled, Secondary, Unimportant Actions) */
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        #elements button{
            margin-top:42px;
        }
        #elements > div{
            height: 300px;
        }
        #box-1-buttons{
            display: grid;
            grid-template-columns: auto auto;
            gap:20px;
            width: 100%;
            margin-top: 42px !important;
        }
        #box-1-buttons button{
            margin: 0 !important;
        }
        #box-2-buttons{
            display: grid;
            grid-template-columns: auto auto;
            gap:20px;
            width: 100%;
            margin-top: 0 !important;
        }
        #box-2-buttons button{
            margin: 0 !important;
        }
        #user-form > div > span{
            color:green;
        }
        #user-form > div > .x-icon{
            color:red;
        }
        #live-camera-container img{
            width: 200px;
        }
        .yes-icon{
            color:green;
        }
        .x-icon{
            color:red;
        }
        #box-3-buttons{
            width:100%;
            display: grid;
            grid-template-columns: auto auto;
            gap:10px;
            margin: 17px 0 0 0 !important
        }
        #box-3-buttons button, #box-3-buttons input, #fileInput{
            margin: 0 !important;
        }
        input[type="file"]#fileInput {
            display: none; /* Hide default input */
        }
        #uploadForm{
            width: 100%;
        }
        #fileInputLabel{
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 17px !important;
            font-size:13px;
            display: inline-block;
            transition: 0.3s;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
        }
        /*#box-3-buttons input{*/
        /*    width: 40%;*/
        /*}*/
        .image-container{
            margin: 0;
            padding: 0;
        }
        .image-container img {
            filter: blur(10px); /* Apply blur initially */
            transition: filter 0.3s ease-in-out; /* Smooth transition */
        }

        .image-container img:hover {
            filter: blur(0px); /* Remove blur on hover */
        }
        .keys-container {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .key-box {
            width: 45%; /* Ensures two boxes fit in one row */
            min-width: 300px;
            max-width: 500px;
            padding: 15px;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border: 2px solid #007BFF;
            border-radius: 10px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            text-align: center;
        }

        .key-text {
            display: -webkit-box;
            -webkit-line-clamp: 3; /* Limit to 3 lines */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: pre-wrap;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .expanded {
            display: block;
            -webkit-line-clamp: unset;
            -webkit-box-orient: unset;
            overflow: visible;
            text-overflow: unset;
        }

        .download-btn {
            margin-top: 10px;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: bold;
            color: white;
            background-color: #28a745; /* Green */
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }

        .download-btn:hover {
            background-color: #1e7e34;
        }
    </style>
</head>
<body class="body">

<div class="main">
    <h1 style="margin-bottom: 0;">Identification Process</h1>
    <div>
        <p th:if="${user.isAccountVerified}" style="margin:0;padding:0;">
            You have successfully verified your identity.
            <span class="yes-icon" th:if="${user.isAccountVerified}">&#10004;</span>
        </p>
        <p th:if="${user.isAccountVerified == false}" style="margin:0;padding:0;">
            You need to complete the verification steps below in order to verify your identity!
            <span class="x-icon" th:if="${!user.isAccountVerified}">&#10008;</span>
        </p>
        <br>
    </div>
<div id="elements">
    <!-- 1. Personal Information Box -->
    <div id="user-form-container" class="id-box">
        <h2>Step 1: Personal Information</h2>
        <div class="box-content">
            <form id="user-form" th:action="@{/data/upload-data}" method="post">
                <div class="input">
                <label for="username">Username:</label>
                <input type="text" id="username" class="user-input" th:field="${user.username}" disabled />
                </div>

                <div class="input">
                <label for="email">Email:</label>
                <input type="email" id="email" class="user-input" th:field="${user.email}" disabled />
                </div>

                <div class="input">
                <label for="name">First Name:</label>
                <input type="text" id="name" class="user-input" th:field="${user.name}" disabled />
                <span class="check-icon" th:if="${user.nameVerified}">&#10004;</span>
                    <span class="x-icon" th:if="${!user.nameVerified}">&#10008;</span>
                </div>

                <div class="input">
                <label for="surname">Last Name:</label>
                <input type="text" id="surname" class="user-input" th:field="${user.surname}" disabled />
                <span class="check-icon" th:if="${user.surnameVerified}">&#10004;</span>
                    <span class="x-icon" th:if="${!user.surnameVerified}">&#10008;</span>
                </div>

                <div class="input">
                <label for="ssn">SSN:</label>
                <input type="text" id="ssn" class="user-input" th:field="${user.ssn}" disabled />
                <span class="check-icon" th:if="${user.ssnVerified}">&#10004;</span>
                    <span class="x-icon" th:if="${!user.ssnVerified}">&#10008;</span>
                </div>

                <button type="button" class="btn-primary" id="edit-btn" onclick="enableEdit()">EDIT</button>
                <div id="box-1-buttons">
                <button type="submit" class="btn-success" id="save-btn">SAVE</button>
                <button type="button" class="btn-danger" id="cancel-btn" onclick="disableEdit()">CANCEL</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. Live Camera Capture Box -->
    <div id="live-camera-container" class="id-box">
        <h2 id="box-2-title">Step 2: Live Camera Capture</h2>
        <div class="box-content">
            <div id="box-2-pictures">
                <img src="/scan-confirm.jpg" th:if="${user.faceVerified}">
                <img src="/scan-not-confirm.jpg" th:if="${!user.faceVerified}">
            </div>
            <video id="camera-preview"></video>
            <button type="button" id="start-camera" class="btn-primary" onclick="startCamera()">SCAN</button>
            <div id="box-2-buttons">
            <button id="scan-photo" class="btn-warning" onclick="capturePhoto()">UPLOAD</button>
            <button class="btn-danger" onclick="restartCameraBox()">CANCEL</button>
            </div>
        </div>
    </div>

    <!-- 3. ID Card Upload Box -->
    <div id="id-upload-container" class="id-box">
        <h2>Step 3: Upload ID Card</h2>
        <div class="box-content">
            <div class="image-container">
            <img th:if="${image != null}" th:src="'data:image/png;base64,' + ${image}" alt="User ID Image" width="150">
            </div>

            <i th:if="${image == null}" id="box-3-image" class="fas fa-id-card id-icon" width="150"></i>
            <form id="uploadForm" method="post" action="/data/upload-id" enctype="multipart/form-data">
<!--                <label for="fileInput">Upload your ID:</label>-->

                <label for="fileInput" id="fileInputLabel" class="btn-primary">CHOOSE A FILE</label>
                <input type="file" id="fileInput" name="file" accept="image/*" required>
                <div id="box-3-buttons">

                <button type="submit" class="btn-warning">UPLOAD</button>
                    <button type="button" class="btn-danger" id="cancelButton">CANCEL</button>

                </div>
            </form>
        </div>
    </div>
</div>
    <br>
    <h1 style="margin-bottom: 0;">Key Generator</h1>
    <div>
        <p th:if="${user.isAccountVerified}" style="margin:0;padding:0;">
            You can use your Public and Private Keys for authentication!
            <span class="yes-icon" th:if="${user.isAccountVerified}">&#10004;</span>
        </p>
        <p th:if="${user.isAccountVerified == false}" style="margin:0;padding:0;">
            You need to verify your identity in order to generate the keys!
            <span class="x-icon" th:if="${!user.isAccountVerified}">&#10008;</span>
        </p>
    </div>

    <div class="keys-container">
            <div class="key-box">
                <h3><i class="fa-solid fa-key" style="color:orange;"></i> PUBLIC KEY</h3>
                <hr>
                <p th:if="${!user.accountVerified}">
                    <i class="fa-solid fa-lock" style="color: red; font-size: 24px;"></i>
                </p>
                <div th:if="${user.accountVerified}">
                <p class="key-text" onclick="toggleExpand(this)" th:text="${publicKey}"></p>
                <button class="download-btn" th:attr="data-key=${publicKey}" onclick="downloadKey(this, 'public_key.txt')">
                    Download Public Key
                </button>
                </div>
            </div>

            <!-- Private Key Box -->
            <div class="key-box">
                <h3><i class="fa-solid fa-key" style="color:red;"></i> PRIVATE KEY</h3>
                <hr>
                <p th:if="${!user.accountVerified}">
                    <i class="fa-solid fa-lock" style="color: red; font-size: 24px;"></i>
                </p>
                <div th:if="${user.accountVerified && privateKey != null}">
                <p class="key-text" onclick="toggleExpand(this)" th:text="${privateKey}"></p>
                <button class="download-btn" th:attr="data-key=${privateKey}" onclick="downloadKey(this, 'private_key.txt')">
                    Download Private Key
                </button>
                </div>
                <div th:if="${user.accountVerified && privateKey == null}">
                    <i class="fa-solid fa-lock" style="color: red; font-size: 24px;"></i>
                    <p>You should keep your Private Key secure and not share with anyone!</p>
                    <p><a href="/data/generate-keys"><b><i>Click here</i></b></a> if you want to generate new keys!</p>
                </div>
            </div>
    </div>


    <div id="documents">
        <h2>Upload PDF for Signing</h2>

        <form method="post" action="/upload-document" enctype="multipart/form-data">
            <input type="file" name="file" accept="application/pdf" required>
            <label>
                <input type="radio" name="choice" value="true" required> Confidential
            </label>
            <label>
                <input type="radio" name="choice" value="false" required> Public
            </label>
            <button type="submit">Upload & Sign</button>
        </form>

        <p th:if="${message}" th:text="${message}"></p>

        <p th:if="${signedPdf}">
            <a th:href="${signedPdf}" download>Click here to download your signed PDF</a>
        </p>
    </div>
</div>

<!--<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js">-->

<!--    console.log("IM HERE");-->
<!--    import CryptoJS from "crypto-js";-->

<!--    const secretKey = "1234567890123456"; // SAME as in backend-->

<!--    async function fetchAndDecryptPrivateKey() {-->
<!--        try {-->
<!--            // Example private key (This should come from the backend)-->
<!--            // Fetch encrypted private key from backend-->
<!--            const response = await fetch(`/get-encrypted-private-key`);-->
<!--            const encryptedPrivateKey = await response.text();-->
<!--            console.log("Encrypted Private Key:", encryptedPrivateKey);-->

<!--            // Decrypt private key using AES-->
<!--            const decryptedBytes = CryptoJS.AES.decrypt(encryptedPrivateKey, secretKey);-->
<!--            const decryptedPrivateKey = decryptedBytes.toString(CryptoJS.enc.Utf8);-->

<!--            console.log("Decrypted Private Key:", decryptedPrivateKey);-->
<!--        } catch (error) {-->
<!--            console.error("Error fetching or decrypting private key:", error);-->
<!--        }-->
<!--    }-->

<!--    // Call the function-->
<!--    fetchAndDecryptPrivateKey();-->
<!--    // Call function to get and decrypt the key-->

<!--</script>-->
<script>

    // document.getElementById("save-btn").style.display = "none";
    // document.getElementById("cancel-btn").style.display = "none";
    document.getElementById("box-1-buttons").style.display = "none";
    document.getElementById("box-2-buttons").style.display = "none";
    document.getElementById("box-3-buttons").style.display = "none";

    // var image = "[[${image}]]";

    document.getElementById("fileInput").addEventListener("change", function() {
        if (this.files.length > 0) {
            handleFileUpload(this.files[0]); // Call the function after selecting a file
        }
    });
    document.getElementById("cancelButton").addEventListener("click", function(event) {
        event.preventDefault(); // Stop form submission
        restartCameraBox();
    });

    function toggleExpand(element) {
        element.classList.toggle("expanded"); // Toggle between collapsed and expanded
    }

    function downloadKey(button, filename) {
        let keyContent = button.getAttribute("data-key"); // Get key content

        if (!keyContent || keyContent.trim() === "") {
            alert("Key is empty or not available.");
            return;
        }

        let blob = new Blob([keyContent], { type: "text/plain" });
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }


    function handleFileUpload(file) {
        console.log("File uploaded:", file.name);
        document.getElementById("box-3-buttons").style.display = "block";
        document.getElementById("fileInput").style.display = "none";
        document.getElementById("fileInputLabel").style.display = "none";
        // You can add further actions here, like sending the file to the backend
    }

    function enableEdit() {
        document.querySelectorAll("#user-form-container input").forEach(input => input.disabled = false);
        document.getElementById("edit-btn").style.display = "none";
        // document.getElementById("save-btn").style.display = "inline-block";
        // document.getElementById("cancel-btn").style.display = "inline-block";
        document.getElementById("box-1-buttons").style.display = "inline-block";
    }

    function disableEdit() {
        document.querySelectorAll("#user-form-container input").forEach(input => input.disabled = true);
        document.getElementById("edit-btn").style.display = "inline-block";
        // document.getElementById("save-btn").style.display = "none";
        // document.getElementById("cancel-btn").style.display = "none";
        document.getElementById("box-1-buttons").style.display = "none";
    }

    let videoStream = null;
    function startCamera() {
        let video = document.getElementById("camera-preview");
        let startButton = document.getElementById("start-camera");
        let scanButton = document.getElementById("scan-photo");

        document.getElementById("box-2-title").style.display = "none";
        document.getElementById("box-2-buttons").style.display = "none"
        document.getElementById("box-2-pictures").style.display = "none";

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                videoStream = stream;
                video.srcObject = stream;
                video.play();
                video.style.display = "block";
                startButton.style.display = "none";
                scanButton.style.display = "inline-block";
                document.getElementById("box-2-buttons").style.display = "inline-block";
                document.getElementById("box-2-pictures").style.display = "none";

            })
            .catch(error => {
                alert("Error accessing camera: " + error.message);
            });
    }

    function capturePhoto() {
        let video = document.getElementById("camera-preview");
        let canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        let ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        let imageData = canvas.toDataURL("image/png"); // Convert to base64
        console.log("Captured Image:", imageData.substring(0, 100) + "..."); // Log first 100 chars

        // Convert base64 to Blob (optional, but preferred for sending)
        let blob = dataURItoBlob(imageData);

        // Create FormData to send as a file
        let formData = new FormData();
        formData.append("livePhoto", blob, "live_capture.png");

        // restartCameraBox();

        // Send data to the backend via AJAX
        // fetch("/data/upload-live-photo", {
        //     method: "POST",
        //     body: formData,
        // })
        //     // .then(response => response.json())
        //     // .then(data => {
        //     //     if (data.success) {
        //     //         alert("Photo uploaded successfully!");
        //     //     } else {
        //     //         alert("Upload failed: " + data.message);
        //     //     }
        //     // })
        //
        //     .catch(error => {
        //         console.error("Error uploading photo:", error);
        //         alert("There was an error uploading the photo.");
        //     });

        fetch("/data/upload-live-photo", {
            method: "POST",
            body: formData,
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Upload failed");
                }
                console.log("Upload success! Reloading...");
                setTimeout(() => {
                    location.reload();
                }, 1000);
            })
            .catch(error => {
                console.error("Error uploading photo:", error);
                alert("There was an error uploading the photo.");
            });


        // Stop camera stream
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
        }
    }

    /**
     * Converts a Base64 data URL to a Blob object
     * This is necessary for proper file uploads
     */
    function dataURItoBlob(dataURI) {
        let byteString = atob(dataURI.split(",")[1]);
        let mimeString = dataURI.split(",")[0].split(":")[1].split(";")[0];

        let arrayBuffer = new ArrayBuffer(byteString.length);
        let uint8Array = new Uint8Array(arrayBuffer);

        for (let i = 0; i < byteString.length; i++) {
            uint8Array[i] = byteString.charCodeAt(i);
        }

        return new Blob([uint8Array], { type: mimeString });
    }
    function restartCameraBox(){
        window.location.reload();
        console.log("RELOAD");
        // document.getElementById("box-2-title").style.display = "block";
        // document.getElementById("box-2-buttons").style.display = "none";
        // document.getElementById("camera-preview").style.display = "none";
        // document.getElementById("box-2-pictures").style.display = "block";
        // document.getElementById("start-camera").style.display = "block";
    }
</script>
